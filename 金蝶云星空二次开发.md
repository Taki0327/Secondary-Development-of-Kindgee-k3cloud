# 金蝶云星空BOS二次开发

## 项目总览

![云星空BOS二次开发 (1)](/金蝶云星空二次开发.assets/云星空BOS二次开发 (1).svg)

## 开发规范

![开发规范](D:\代码\金蝶云星空二次开发.assets\开发规范.png)

## 开发流程

### 创建单据时序图

![1644807114420](D:\代码\金蝶云星空二次开发.assets\1644807114420.png)

### 修改单据时序图

![1644807182370](D:\代码\金蝶云星空二次开发.assets\1644807182370-16448072491233.png)

## 接口结构

> 官方接口文档 [Innovasys RealWorld (kingdee.com)](https://open.kingdee.com/K3Cloud/SDK/webframe.html) 

### AbstractBillPlugIn（单据插件）

#### Context（上下文）

#### ViewPlugin（视图）

| **接口**          | **功能**           |
| ----------------- | ------------------ |
| OnBilInitialize   | 视图模型初始化事件 |
| [AfterBindData](#AfterBindData)     |  绑定数据后事件处理接口             |
| [BeforeF7Select](#BeforeF7Select) | 基础资料弹出前事件 |
| BeforeClosed      | 窗口关闭前事件 |
| [BarItemClick](#BarItemClick)      | 菜单单击事件处理扩展接口 |
| AfterBarItemClick | 菜单单击事件后 |
| BeforeDoOperation | 操作调用前事件 |
| AfterDoOperation  | 操作调用完成后事件 |
| [ButtonClick](#ButtonClick)       | 按钮单击事件 |
| AfterButtonClick  | 按钮单击后事件 |
| ListViewClick     | 列表项目单击事件 |
| TreeNodeClick     | 树控件单击事件 |
| EntityRowClick    | 分录行单击事件 |

#### Model（模型）

动态表单数据模型插件编程接口
定义了数据模型扩展
允许通过接口处理数据,以实现特定业务需求

####  方法

| **方法**   | **功能**           |
| ----------------- | ------------------ |
|CreateNewData|数据模型创建实体对象事件|
|AfterCreateNewData|数据模型创建实体对象完成后事件|
|BeforeUpdateValue|数据更新前事件|
|[DataChanged](#DataChanged)|数据改变后事件|
|CreateNewEntryRow|创建分录行事件|
|BeforeDeleteRow|删除分录行事件|
|AfterDeleteRow|删除分录后事件|
|AfterCopyData|复制单据完毕后事件|
|AfterLoadData|业务对象加载后的扩展接口|
|AfterSave|调用应用服务保存成功后触发|
|AfterSetStatus|设置单据状态后调用|
|AfterSubmit|调用应用服务提交成功后触发|
|[BeforeSave](#BeforeSave)|调用应用服务器，提交数据保存前触发|
|BeforeSetStatus|设置单据状态前调用|
|BeforeSubmit|调用应用服务器，提交前触发|
|CopyData|复制单据|
|LoadData|加载业务对象扩展接口|
|SaveBillFailed|调用应用服务保存失败，出错时触发|
|VerifyImportData|数据导入校验|

## 常用对象

> 单据体行索引从0开始 0为第一行 1为第二行......

### **View**

#### 属性

##### BillBusinessInfo (界面业务对象元数据)

##### LayoutInfo (布局元数据)

##### Model (动态表单模型接口)

##### OpenParameter (页面调用时传入的参数)

##### BusinessInfo (当前表单对象的逻辑元数据)

##### Context（上下文）

##### Pageld（当前动态表单唯一标识）

##### ParentFormView（父窗体动态表单视图接口）

##### Session（数据缓存区，与其他对象进行简单的数据传递）

##### StyleManager（返回关联的样式管理器）

#### 方法

##### GetFieldEditor (获取界面控件对象) *tips：同JavaScript的获取控件ID控制控件*

```c#
/// <summary>
/// 设置金额列精度
/// </summary>
/// <param name="iScale"></param>
/// <param name="strField"></param>
private void SetColumnScale(short iScale, string strField)
{
	this.View.GetFieldEditor<DecimalFieldEditor>(strField, 1).Scale = iScale;
}
```

##### ShowMessage (显示信息)
<a name="ButtonClick"></a>
```c#
public override void ButtonClick(ButtonClickEventArgs e)
{
	base.ButtonClick(e);
    if (e.Key.Equals(ButtonKey, StringComparison.OrdinalIgnoreCase))
    {
    	this.View.ShowMessage("是兄弟就来砍我");
    }
}
```
##### ShowErrMessage (显示错误信息)

<a name="BarItemClick"></a>

```c#
public override void BarItemClick(BarItemClickEventArgs e)
{
    base.BarItemClick(e);
    switch(e.BarItemKey.ToLower())
    {
        case "tbsplitsave":
        case "tbsave":
            object objCreator = this.Model.GetValue("F_PAE_Creator");
            if(objCreator.IsNullOrEmptyOrWhiteSpace())//判断控件值是否为空
            {
                this.View.ShowErrMessage("对不起，创建人不能为空");
                e.Cancel=true;
            }
    }
}
```

##### GetMainBarItem (主菜单控制) *tips：不能放在初始化里 会被渲染操作给覆盖*
<a name="AfterBindData"></a>
```c#
/// <summary>
/// 数据加载之后，需要处理的功能，这里主要对界面样式进行处理，尽量不要对Datamodel进行处理
/// </summary>
/// <param name="e"></param>
public override void AfterBindData(EventArgs e)
{
	this.View.GetMainBarItem("tbButton").Enabled = false;
}
```

##### GetControl (控件控制)

```c#
//禁用FNote控件
this.View.GetControl("FNote").Enabled = false;

//获取焦点 光标转移至该控件
this.View.GetControl("FNote").SetFocus();
```

##### GetFieldEditor（单据体控制）

```c#
//禁用单据体中FEntryNote列的第0行
this.View.GetFieldEditor("FEntryNote",0).Enabled = false;
```
##### GetFormTitle （获取单据标题）

```c#
string FormTitle = this.View.GetFormTitle();
```
##### UpdateView（刷新页面）

```c#
this.View.UpdateView("FNote");
```

##### Refresh（刷新页面及数据）

```c#
this.View.Refresh();
```

##### InvokeFormOperation（调用表单事件）

```c#
this.View.InvokeFormOperation("Save");
```

GetFormOperation（获取指定操作编码的的操作实例对象）
LockField（锁定或者解锁字段）
GetBarltem（获取工具栏、按钮、分录表格菜单项控件编程对象）
ShowForm（显示动态表单界面 关闭窗体时有回调函数处理)
SendDynamicFormAction（执行指定动态表单视图的客户端指令）
InvokeFieldUpdateService（执行指定字段的表单服务）

### Model

#### 属性

##### Context（上下文）

##### DataObject (当前对象的数据实体) *tips:常用于CreateNewData*

```c#
/// <summary>
/// 获取分类目录
/// </summary>
DynamicObjectCollection entrys = (DynamicObjectCollection)this.Model.DataObject["PoorderEntry"];

//获取单据体指定列数据 tips：参数为数据库元祖名去掉开头的F
//查询单据内码
string FormTitle = this.Model.DataObject["Id"].ToString();
```

#### 方法

##### CreateNewEntryRow（新增行单据体信息）
```c#
this.Model.CreateNewEntryRow("FSaleOrderEntry");
```
##### GetEntryCurrentRowIndex（获取分录当前行索引）

##### TryGetEntryCurrentRow（尝试返回某个分录的当前选中的实体）

##### InsertEntryRow（插入分录行）

##### GetEntityDataObject（获取单据体分录对应的数据集合）

##### WriteLog（写上机操作日志）

##### FuncPermissionAuth（判断功能权限）

##### GetEntryRowCount（获取单据体数据行数量）

```c#
this.Model.GetEntryRowCount("FSaleOrderEntry");
```

##### GetPKValue（获取单据内码）

```c#
string FormTitle = this.Model.GetPKValue().ToString();
```
##### GetEntryPKValue（获取单据体内码）

```c#
this.Model.GetEntryPKValue("FSaleOrderEntry", 0);
```

##### CopyEntryRow（复制行单据体信息）

```c#
this.Model.CopyEntryRow("FSaleOrderEntry", 0, 1, false);//最后一个参数代表是否携带源单关系
```

##### DeleteEntryData（删除单据体信息）

```c#
this.Model.DeleteEntryData("FSaleOrderEntry");
```

##### DeleteEntryRow（指定行删除单据体信息）

```c#
this.Model.DeleteEntryRow("FSaleOrderEntry",0);
```
##### GetValue（获取字段(对象)值）

```c#
string message = "";
//获取单据头文本字段
object billNo = this.Model.GetValue("FBillNo");
if (billNo != null)
{
	message += "[FBillNo:" + billNo.ToString() +"]" ;
}

//获取基础资料字段
DynamicObject baseCoin = this.Model.GetValue("F_PAE_BaseCoin") as DynamicObject;
if (baseCoin != null)
{
	message += "[F_PAE_BaseCoin:" + baseCoin["Name"] + "]";
}

//获取单据体中的所有行数据
Entity fentity = this.View.BillBusinessInfo.GetEntity("FEntity");
DynamicObjectCollection entityObjs = this.Model.GetEntityDataObject(fentity);
for (int i = 0; i < entityObjs.Count; i++)
{
	message += "[row" + (i + 1) + ":" + entityObjs[i]["F_PAE_ItemName"] + "]";
}

//获取单据体选中行的数据
int[] selectedRows = this.View.GetControl<EntryGrid>("FEntity").GetSelectedRows();
DynamicObjectCollection entityObjs2 = this.Model.GetEntityDataObject(fentity);
foreach (var row in selectedRows)
{
	message += "[selected row" + (row + 1) + ";" + entityObjs[row]["F_PAE_ItemName"] + "]";
}

//快速获取单据体中某不字段的值(如果行不存在时，会中断)
object itemName = this.Model.GetValue("F_PAE_ItemName", 0);
if (itemName != null)
{
	message += "[quick row 1:" + itemName.ToString() + "]";
}
this.View.ShowMessage(message);
```

##### SetValue (设置字段(对象)值)
<a name="DataChanged"></a>

```c#
/// <summary>
/// 字段修改事件函数重载
/// </summary>
/// <param name="e"></param>
public override void DataChanged(DataChangedEventArgs e)
{
    //数据改变时使用switch进行多选判断
	switch(e.Key.ToUpper())
    {
    	case "FPARENTDEPTID":
            this.Model.SetValue("FFullName", GetFullName(e.Key));
            break;
    }
    
    //根据另一个控件值赋值控件
    this.Model.SetValue("F_UPPS_Text1", this.Model.GetValue("F_UPPS_Text").ToString());
    
    //根据 Context 上下文属性取控件值
    this.Model.SetValue("F_UPPS_Text1", Convert.ToString(this.Context.DatabaseType));//强转为string
        
    //设置单据头字段的值
    this.Model.SetValue("FBillNo","test setValue");
    
    //设置基础资料的值(根据内码)
    this.Model.SetValue("F_PAE_BaseCoin", "1");
    
    //设置基础资料的值(根据编码)
    this.Model.SetItemValueByNumber("F_PAE_BaseCoin",“PRE001", -1);
                                    
    //设置单据体中字段的值 (字段，数值，行数)
    this.Model.SetValue("F_PAE_Quantity", 5, 0):
    this.Model.SetValue("F_PAE_Price", 20, 0);
                                    
    //根据改变发生的字段
    if(e.Field.Key=="")
	{
        //给A字段FCustIdNew,赋新值e.NewValue,更新前的值
        this.Model.SetValue("FCustIdNew",e.NewValue);
        //给B字段FCustIdOld,赋旧值e.OldValue,更新后的值
        this.Model.SetValue("FCustIdOld",e.OldValue);
        //根据单据体内容更改 改变相同记录中的字段
        this.Model.SetValue("F_YDIE_ProjectName", "项目名称" +e.Row.ToString(), e.Row);
    }
                                    
	//操作控件过多时可通过switch case简化代码 避免多个if
	switch(e.Field.Key)
	{
        case "":;break;
    }
}
```


## 示例代码

> [【新手入门】插件实操【分享汇总】 (kingdee.com)](https://vip.kingdee.com/article/64993872014591232)
>
> [金蝶云星空BOS二次开发案例演示 (kingdee.com)](https://vip.kingdee.com/article/94751030918525696)

### DynamicObject（单据数据包）

相当于一个**有层次结构的数据字典**
基本特征：

1. 包含了全部单据头字段值

2. 包含了单据体行集合对象

3. 字段通过Key + Value，形成一个键值对，占据DynamicObject的一个节点

4. 字段在数据包中的Key，使用的是字段的属性名

5. 基础资料字段的值，也是一个DynamicObject对象，其中嵌套包含了各个引用属性的值

   > [DynamicObject动态数据包分析 (kingdee.com)](https://vip.kingdee.com/article/45021)
   > [DynamicObject结构说明 - 苏暖暖 - 博客园 (cnblogs.com)](https://www.cnblogs.com/nikki1206/p/15488889.html)

#### 方法一：直接操作DynamicObject
```c#
// 假设billObj是单据的数据包
DynamicObject billObj = this.Model.DataObject;

// 读取单据内码
long billId = Convert.ToInt64(billObj[0]);

// 普通文本字段（读取 + 设置）
string fldBillNoValue = Convert.ToString(billObj["BillNo"]);
billObj["BillNo"] = fldBillNoValue ;

// 日期字段（读取 + 设置）
DateTime fldDateValue = Convert.ToDateTime(billObj["F_JD_Date"]);
billObj["F_JD_Date"] = fldDateValue;

// 基础资料字段(读取 + 设置)
DynamicObject fldSupplierValue = billObj["F_JD_Supplier"] as DynamicObject;
billObj["F_JD_Supplier"] = fldSupplierValue ;
if (fldSupplierValue != null)
{ 
    billObj["F_JD_Supplier_Id"] = Convert.ToInt64(fldSupplierValue[0]);
    long supplierId = Convert.ToInt64(fldSupplierValue[0]);
    string supplierNumber = fldSupplierValue["Number"].ToString();
    string supplierName = fldSupplierValue["Name"].ToString();
}

// 单据体（单据体行集合属性本身只读，可以通过单据体集合提供的方法，添加行、删除行）
DynamicObjectCollection entityRows = billObj["FEntity"] as DynamicObjectCollection;
foreach (var entityRow in entity1Rows)
{
    // 内码
    long entityId = Convert.ToInt64(entityRow[0]);
    // 数量 （读取 + 设置）
    decimal fldQtyValue = Convert.ToDecimal(entityRow["F_JD_Qty"]);
    entityRow["F_JD_Qty"] = fldQtyValue;
}
```

#### 方法二：通过字段的元数据，操作DynamicObject

```c#
// 假设billObj是单据的数据包
DynamicObject billObj = this.Model.DataObject;

// 首先获取各种元素的元数据
Field fldBillNo = this.View.BillBusinessInfo.GetField("FBillNo");
Field fldDate = this.View.BillBusinessInfo.GetField("F_JD_Date");
BaseDataField fldSupplier = this.View.BillBusinessInfo.GetField("F_JD_Supplier") as BaseDataField;
BaseDataField fldMaterial = this.View.BillBusinessInfo.GetField("F_JD_FMaterialId") as BaseDataField;
Field fldQty = this.View.BillBusinessInfo.GetField("F_JD_Qty");
Entity entity = this.ListView.BillBusinessInfo.GetEntity("FEntity");

// 读取单据内码
long billId = Convert.ToInt64(billObj[0]);

//单据编号
string billNo = Convert.ToDateTime(fldBillNo.DynamicProperty.GetValue(billObj));
fldBillNo.DynamicProperty.SetValue(billObj, billNo));

// 日期
DateTime fldDateValue = Convert.ToDateTime(fldDate.DynamicProperty.GetValue(billObj));
fldDate.DynamicProperty.SetValue(billObj, fldDateValue)
    
// 供应商：基础资料字段
DynamicObject fldSupplierValue = fldSupplier.DynamicProperty.GetValue(billObj) as DynamicObject;

// 设置供应商基础字段值
DynamicObject[] supplierObjs = Kingdee.BOS.ServiceHelper.BusinessDataServiceHelper.LoadFromCache(
this.Context,
new object[] { fldSupplierValue[0] },
fldSupplier.RefFormDynamicObjectType);
fldSupplier.RefIDDynamicProperty.SetValue(billObj, supplierObjs[0][0]);
fldSupplier.DynamicProperty.SetValue(billObj, supplierObjs[0]);

// 基础资料属性值
if (fldSupplierValue != null)
{
    long supplierId = Convert.ToInt64(fldSupplierValue[0]);
    string supplierNumber = fldSupplier.GetRefPropertyValue(fldSupplierValue, "FNumber").ToString();
    string supplierName = fldSupplier.GetRefPropertyValue(fldSupplierValue, "FName").ToString();
}

// 单据体的字段
DynamicObjectCollection entityRows = entity.DynamicProperty.GetValue(billObj) as DynamicObjectCollection;
foreach (var entityRow in entityRows)
{
    // 内码
    long entityId = Convert.ToInt64(entity1Row[0]);
    // 物料：基础资料字段
    DynamicObject fldMaterialValue = fldMaterial.DynamicProperty.GetValue(entityRow) as DynamicObject;
    if (fldMaterialValue != null)
    {
        long materialId = Convert.ToInt64(fldMaterialValue[0]);
        string materialNumber = fldMaterial.GetRefPropertyValue(fldMaterialValue, "FNumber").ToString();
        string materialName = fldMaterial.GetRefPropertyValue(fldMaterialValue, "FName").ToString();
    }
    // 数量
    decimal fldQtyValue = Convert.ToDecimal(fldQty.DynamicProperty.GetValue(entityRow));
    fldQty.DynamicProperty.SetValue(entityRow, fldQtyValue);
}

// 给单据体添加新行
DynamicObject newRow = new DynamicObject(entity.DynamicObjectType);
entityRows.Add(newRow);
```

### 查询数据

```c#
var formMetaData = FormMetaDataCache.GetCachedFormMetaData(this.Context, "PAE_ZyDemoBase3");
var dynamicObjType = formMetaData.BusinessInfo.GetDynamicObjectType();
string result = "";
//根据内码来查询单据数据
DynamicObject dynamicObj = BusinessDataServiceHelper.LoadSingle(this.Context, "100001", dynamicObjType);
if (dynamicObj != null)
{
	this.View.ShowMessage(dynamicObj["BILLM0"].ToString());
}

//根据内码查询多条数据
DynamicObject[] dynamic0bjs = BusinessDataServiceHelper.Load(this.Context, new object[] { " 10001", "10002" }, dynamicObjType);
foreach (var obj in dynamic0bjs)
{
	result +=obj["BILLNO"].ToString();
}
this.View.ShowErrMessage(result);

//根据自定义的查询条件来查询单据数据
QueryBuilderParemeter query = new QueryBuilderParemeter();
query.FormId ="PAE_ZyDenoBase3";
query.FilterClauseWihtKey = "FNillNo='F001'";//单据编号 根据key 
query.BusinessInfo = formMetaData.BusinessInfo;
query.SelectItems.Add(new SelectorItemInfo("BillNo"));
DynamicObject[] dynamic0bjs = BusinessDataServiceHelper.Load(this.Context, dynamicObjType, query);
foreach(var obj in dynamic0bjs)
{
	result += obj["BILLNO"].ToString() + ",";
}
this.View.ShowErrMessage(result);

//自定义查询条件以及查询列
List<SelectorItemInfo> selectItems = new List<SelectorItemInfo>();
selectItems.Add(new SelectorItemInfo("FBi1lNo"));
selectItems.Add(new SelectorItemInfo("F_PAE_Base"));
OQLFilter oFilter = new OQLFilter();
oFilter.Add(new OQLFilterHeadEntityItem() { FilterString = "FBillBNo='F001'" });
oFilter.Add(new OQLFilterHeadEntityItem() { EntityKey="FEntity",FilterString = "F_PAE_Base=110958" });//根据单据体某个字段
oFilter.Add(new OQLFilterHeadEntityItem() { EntityKey = "FEntity", FilterString = "F_PAE_Base.FNumber" });//根据单据体基础资料编码
DynamicObject[] dynamicObjs = BusinessDataServiceHelper.Load(this.Context, "PAE_ZyDemoBase3", selectItems, oFilter);
foreach(var obj in dynamicObjs)
{
	result +=obj["BILLNO"].ToString() + ",";
}
this.View.ShowErrMessage(result);

//queryservice取数 通过业务对象获取数据
public DynamicObjectCollection GetQueryDatas()
{
    QueryBuilderParemeter paramCatalog = new QueryBuilderParemeter()
    {
        FormId = "",//取数的业务对象
        FilterClauseWihtKey = "",//过滤条件，通过业务对象的字段Key拼接过滤条件
        SelectItems = SelectorItemInfo.CreateItems("", "", ""),//要筛选的字段【业务对象的字段Key】，可以多个
    };
    DynamicObjectCollection dyDatas = QueryServiceHelper.GetDynamicObjectCollection(this.Context, paramCatalog);
    return dyDatas;
}
```

### 弹窗

#### 子窗体返回数据至父窗体

```c#
this.View.ReturnToParentWindow(this.Model.DataObject); //返回子窗体数据

DynamicObject dyo;
int selectedRow = 0;
this.Model.TryGetEntryCurrentRow("FEntity", out dyo, out selectedRow);
if (dyo != null)
{
    DynamicFormShowParameter param = new DynamicFormShowParameter();
    param.FormId = "PAE_ZyDemoBase2";
    param.CustomComplexParams.Add(" SelectItem", dyo);
    this.View.ShowForm(param, (result) =>
    {
        if (result != null)
        {
            DynamicObject resultDyo = result.ReturnData as DynamicObject;
            if (resultDyo == null)
            	return;
            this.Model.SetValue("F_PAE_ItenName", resultDyo["F_PAE_ItenName"]);
            this.Model.SetValue("F_PAE_Price", resultDyo["F_PAE_Price"]);
            this.Model.SetValue("F_PAE_Quantity", resultDyo["F_PAE_Quantity"]);
        }
    });
}
```
#### 提示信息框

##### 询问式

```c#
//MessageBoxOptions.YesNo 是、否
//MessageBoxOptions.YesNoCancel 是、否、取消
this.View.ShowMessage("错误提示,是否继续？",MessageBoxOptions.YesNoCancel,new Action<MessageBoxResult>((result) => //通过result接收值
{
    if (result == MessageBoxResult.Yes)
    {
    }
    else if (result == MessageBoxResult.No)
    {
    }
    else if (result == MessageBoxResult.Cancel)
    {
    }
}));
```

##### 警告式

```c#
this.View.ShowWarnningMessage("操作无法完成",
action: (result) =>
{
    //关闭页面
    this.View.Close();
});
```

##### 处理结果串

```c#
IOperationResult opResult = new OperationResult();
opResult.OperateResult.Add(new OperateResult()
{
    Name = "信息提示",
    Message = "成功",
    SuccessStatus = true
});
opResult.OperateResult.Add(new OperateResult()
{
    Name = "信息提示",
    Message = "失败",
    SuccessStatus = false
});
this.View.ShowOperateResult(opResult.OperateResult);
```

#### ListShowParameter 列表

```c#
ListShowParameter listShowParameter = new ListShowParameter();
listShowParameter.FormId = "STK_InStock";//单据列表唯一标识
//IsLookUp弹出的列表界面是否有“返回数据”按钮
listShowParameter.IsLookUp = true;

//列表显示类型
//只显示单据头基本信息
listShowParameter.ListType = Convert.ToInt32(BOSEnums.Enu_ListType.BaseList);
//全部显示,默认全部显示
listShowParameter.ListType = Convert.ToInt32(BOSEnums.Enu_ListType.List);
//是否显示复选框。默认是true，如果false就是不显示
listShowParameter.MultiSelect = false;

//弹出窗口显示指定单据
this.View.ShowForm(listShowParameter);
//弹出窗口显示指定单据 并通过页面返回数据按钮赋值给原页面
this.View.ShowForm(listShowParameter, delegate (FormResult result)
{
    object returnData=result.ReturnData;
    //判断是否是RowCollection包含选中行集合
    if (returnData is ListSelectedRowCollection)
    {
        ListSelectedRowCollection listSelectedRowCollection = returnData as ListSelectedRowCollection;
        if (listSelectedRowCollection != null)
        {
            DynamicObjectDataRow dataRow = (DynamicObjectDataRow)listSelectedRowCollection[0].DataRow;//获取第一行
            //控件字段名是DynamicObjectDataRow里的名字 需要调试后确认 并不与数据库元祖名&页面控件名相同
            this.Model.SetValue("F_UPPS_Text", dataRow.DynamicObject["FMaterialId_Id"].ToString());
            this.Model.SetValue("F_UPPS_Text1", dataRow.DynamicObject["FStockId_Id"].ToString());
            this.Model.SetValue("F_UPPS_Text2", dataRow.DynamicObject["FDATE"].ToString());
        }
    }
});
```

### 校验输入

<a name="BeforeSave"></a>

```c#
public override void BeforeSave(BeforeSaveEventArgs e)
{
	base.BeforeSave(e); 
    if(Convert.ToString(this.Model.GetValue("F_UPPS_Text1"))=="")//Convert.ToString强转时若出现空值不会报错
    {
        e.Cancel = true;//中断运行
        this.View.ShowMessage("请填写备注信息");
        return;
    }
}
```

### 数据库操作

> **导入Kingdee.BOS.App包**

```c#
//执行sql语句返回Int，表示影响了多少行
int x =  DBUtils.Execute(this.Context, "/*dialect*/update T_SAL_OUTSTOCKENTRY set FNOTE ='测试'");

//执行sql语句返回DataSet
DataTable dt = DBUtils.ExecuteDataSet(this.Context, "/*dialect*/select FMATERIALID,FNumber from T_BD_MATERIAL").Tables[0];
//循环,读取dt表有多少行
for(int i =0; i<dt.Rows.Count;i++)
{
    //新增行
    this.Model.CreateNewEntryRow("FEntity");
    //给基础资料物料,赋值
    this.Model.SetValue("FMaterialId", dt.Rows[i]["FMATERIALID"].ToString(), i);
    //调用物料,值更新
    this.View.InvokeFieldUpdateService("FMaterialID", i);
    //给备注,赋值
    this.Model.SetValue("FEntrynote", dt.Rows[i]["FNumber"].ToString(), i);
}

//执行sql语句返回DataSetDBUtils.ExecuteEnumerable
IEnumerable<IDataRecord> itemDataTable = DBUtils.ExecuteEnumerable(this.Context, "/*dialect*/select FMATERIALID,FNumber from T_BD_MATERIAL");

//执行sql语句,返回DynamicObjectCollection
DynamicObjectCollection Dyobj = DBUtils.ExecuteDynamicObject(this.Context, "/*dialect*/select FMATERIALID,FNumber from T_BD_MATERIAL");

int j = 0;

//IEnumerable
foreach(IDataRecord drItem in itemDataTable)
//DynamicObjectCollection
foreach(DynamicObject obj in Dyobj)
{
    //新增行
    this.Model.CreateNewEntryRow("FEntity");
    //给基础资料物料,赋值
    this.Model.SetValue("FMaterialID", obj["FMATERIALID"].ToString(), j);
    //调用物料,值更新
    this.View.InvokeFieldUpdateService("FMaterialID", j);
    //给备注,赋值
    this.Model.SetValue("FEntrynote", obj["FNumber"].ToString(), j);
    j++;
}
```

#### Excel报表

> 引用 Kingdee.BOS.ServiceHelper 包

```c#

```

### 限定显示

<a name="BeforeF7Select"></a>

```c#
public override void BeforeF7Select(BeforeF7SelectEventArgs e)
{
    switch (e.FieldKey.ToUpperInvariant())
    {
        //case "FXXX":通过字段的Key[大写]来区分不同的基础资料
        //    e.ListFilterParameter.Filter = "FXXX= AND fxxy=";过滤的字段使用对应基础资料的字段的Key，支持ksql语法
        //break;
        case "客户":e.ListFilterParameter.Filter = "FNumber ='003'";//筛选限定只能选择某些客户
            break;
    }
}
```

### 设置控件初始值

```c#
public override void AfterBindData(EventArgs e)
{
	base.AfterBindData(e);
	//判断单据状态ADDNEW、EDIT、VIEW、DISASSEMBLY（新增、编辑、查看、卸载）
	if(this.View.OpenParameter.Status.Equals(OperationStatus.ADDNEW))
	{
		//给备注和备注1,赋值
        this.Model.SetValue("FNote", "备注");
        this.Model.SetValue("FNote1", "备注1");
       
        //获取源单,订单单号FSOORDENDO ,第一行,不等于空
        if (Convert.ToString(this.Model.GetValue("FSOORDERNO", 0)) != "")
        {
            //到数据库里面,寻找,关联的备注信息
            //获取上面关联的值1001,写入销售出库单里面
sql = "/*dialect*/select F_YDIE_TEXT from YDIE_t_Cust_Entry100017 where FID in (select FID from T_SAL_ORDER where FBILLNO ='" + Convert.ToString(this.Model.GetValue("FSOORDERNO", 0)) + "')";
            //读取数据库里面的,执行数据,赋值给ds
            ds = DBUtils.ExecuteDataSet(this.Context, sql);
            //读取第一行数据
            dt = ds.Tables[0];
            //循环dt表,给单据体赋值,如果行大于0
            if (dt.Rows.Count > 0)
            {   //循环读取每一行数据
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    //给备注F_YDIE_TEXT,赋值
                    //dt.Rows[i]行    ["F_YDIE_TEXT"].ToString() 列
                    this.Model.SetValue("F_YDIE_Text", dt.Rows[i]["F_YDIE_TEXT"].ToString(), i);
            	}
            }
        }
	}
}
```

### 获取选中列表行值

```c#
//选择的行,获取所有信息,放在listcoll里面
ListSelectedRowCollection listcoll = this.ListView.SelectedRowsInfo;

//单据头主键
string[] listKey = listcoll.GetPrimaryKeyValues();
//单据体主键
string[] listKey = listcoll.GetEntryPrimaryKeyValues();
if(listKey.Length==0)//判断是否为空
{
}
else
{
    //选中的行数不为空
    string info="";
    foreach (string key in listKey)
    {
        info = info + "," + key;
    }
    this.View.ShowMessage(info);
    foreach (string key in listKey2)
    {
        info = info + "," + key;
    }
    this.View.ShowMessage(info);
}
```

### 打开外部网站

#### 网站嵌套

> **导入Kingdee.BOS.JSON包**

```c#
JSONObject webobj = new JSONObject();
webobj["source"] = @"http://www.baidu.com";
//设置窗口大小
webobj["height"] = 600;
webobj["width"] = 800;
//是否新窗口打开
webobj["isweb"] = true;
webobj["title"] = "百度";
this.View.AddAction("ShowKDWebbrowseForm", webobj);
this.View.SendAynDynamicFormAction(this.View);
```

#### 网站联动
```c#
```



## WebAPI

> 引用 Kingdee.BOS.WebApi.Client 包
>
> 登录管理员账号后开通设置-第三方系统登录授权 并将其配置于项目config配置中

### 查询数据表

```c#
//请求参数（JSON格式）
string FormId;//业务对象表单Id（必填）
string FieldKeys;//需查询的字段key集合，字符串类型，格式;"key1,key2,..."（必填） 注（查询单据体内码,需加单据体Key和下划线,如;FEntryKey_FEntryId）
string FiltefrString;//过滤条件，字符串类型（非必填）
string OrderString;//排序字段，字符串类型（非必填）
string TopRowCount;//返回总行数，整型（非必填）
string StartRow;//开始行索引，整型（非必填）
string Limit;//最大行数，整型，不能超过2000（非必填）

//发送JSON请求接收数据
string json = JsonConvert.SerializeObject(selectList);
List<List<object>> list1 = new List<List<object>>();
list1 = client.ExecuteBillQuery(json);
foreach (List<object> list2 in list1)
{
}
```

## Tips：

###### 协同云开发工具修改前需要签出（服务器），保存后再签入（服务器）才可修改成功。

###### 1.Administrator账户忘记密码可进入管理中心—选中数据中心后重置密码

###### 2.发布单据流程：（1）权限控制中设置权限对象（2）发布到主控—选择子功能—新建明细功能绑定业务对象和权限项
